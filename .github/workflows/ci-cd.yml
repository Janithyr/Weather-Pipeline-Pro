name: Weather Notification Pipeline

on:
  # Run daily at 8:00 AM UTC
  schedule:
    - cron: '0 8 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  daily-weather-notification:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
    
    - name: Fetch today's weather
      id: weather
      run: |
        # Fetch weather data from API (replace with your actual API)
        WEATHER_DATA=$(curl -s "https://api.openweathermap.org/data/2.5/weather?q=London&appid=${{ secrets.WEATHER_API_KEY }}&units=metric")
        echo "data=$WEATHER_DATA" >> $GITHUB_OUTPUT

        # Extract temperature, condition, and description
        TEMP=$(echo $WEATHER_DATA | jq -r '.main.temp')
        CONDITION=$(echo $WEATHER_DATA | jq -r '.weather[0].main')
        DESCRIPTION=$(echo $WEATHER_DATA | jq -r '.weather[0].description')

        echo "temp=$TEMP" >> $GITHUB_OUTPUT
        echo "condition=$CONDITION" >> $GITHUB_OUTPUT
        echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT

    - name: Check for rain
      id: check-rain
      run: |
        CONDITION=${{ steps.weather.outputs.condition }}
        RAIN=false
        if [[ "$CONDITION" == "Rain" ]]; then
          RAIN=true
        fi
        echo "rain=$RAIN" >> $GITHUB_OUTPUT

    - name: Send daily weather email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Today's Weather Forecast"
        body: |
          Good morning! Here's the weather forecast for today:

          Temperature: ${{ steps.weather.outputs.temp }}°C
          Condition: ${{ steps.weather.outputs.condition }}
          Description: ${{ steps.weather.outputs.description }}

          ${{ steps.check-rain.outputs.rain == 'true' && '☔ Rain is expected today. Please carry an umbrella!' || '' }}

          Have a great day!
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: Weather Pipeline Pro
